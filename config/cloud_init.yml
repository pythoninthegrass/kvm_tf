#cloud-config

output: {all: '| tee -a /var/log/cloud-init.log'}   # store logs inside vm

timezone: "America/Chicago"

hostname: ubuntu

package_update: true      # default: true
package_upgrade: false    # default: false  # TODO: set to true
# https://github.com/number5/cloud-init/blob/main/doc/examples/cloud-config-apt.txt#L21
apt_get_command: ["apt-get", "--option=Dpkg::Options::=--force-confold", "--option=Dpkg::options::=--force-unsafe-io", "--assume-yes", "--quiet", "--no-install-recommends"]

apt:
  sources:
    deadsnakes.list:
      source: deb http://ppa.launchpad.net/deadsnakes/ppa/ubuntu $RELEASE main
      keyid: F23C5A6CF475977595C89F51BA6932366A755776
    docker.list:
      source: deb https://download.docker.com/linux/ubuntu $RELEASE stable
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88

packages:
  - ansible
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg-agent
  - python3
  - python3-pip
  - qemu-guest-agent
  - software-properties-common
  - tree
  - vim

ssh_pwauth: true

disable_root: false

chpasswd:
  list: |
     root:toor
  expire: false

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/ubuntu
    shell: /bin/bash
    lock_passwd: false
    ssh-authorized-keys:
      - ${file("~/.ssh/id_rsa.pub")}

  - name: ansible
    plain_text_passwd: 'ansible'
    sudo: [ALL=(ALL) NOPASSWD:ALL]
    gecos: Ansible
    home: /home/ansible
    groups: [admin, users, wheel]
    lock_passwd: true
    shell: /bin/bash
    no_ssh_fingerprints: true

ssh:
  emit_keys_to_console: false

runcmd:
  - systemctl enable --now qemu-guest-agent.service
  - runuser -l ubuntu -c "wget -O - https://github.com/pythoninthegrass.keys | sudo tee -a ~/.ssh/authorized_keys"
  - runuser -l ubuntu -c "ssh-keyscan github.com >> ~/.ssh/known_hosts"
  - runuser -l ubuntu -c "mkdir -p /home/ubuntu/git"
  - runuser -l ubuntu -c "sudo chmod -R 0777 /home/ubuntu/git"
  - runuser -l ubuntu -c "sudo chown -R ubuntu:ubuntu /home/ubuntu/git"
  - runuser -l ansible -c "sudo touch /var/log/ansible.log"
  - runuser -l ansible -c "sudo chown ansible:ansible /var/log/ansible.log"
  - runuser -l ansible -c "sudo chmod 0777 /var/log/ansible.log"

write_files:
  - path: /home/ubuntu/.bash_aliases
    owner: ubuntu:ubuntu
    permissions: '0644'
    append: false
    content: |
      alias ll='ls -FGlAhp'
      alias mkdir='mkdir -pv'
      alias ..='cd ../'
      alias ...='cd ../../'
      cd() { builtin cd "$@"; ll; }

  - path: /home/ubuntu/.bash_profile
    owner: ubuntu:ubuntu
    content: |
      [[ -s ~/.bashrc ]] && source ~/.bashrc

  - path: /home/ubuntu/.gitignore
    owner: ubuntu:ubuntu
    content: |
      .env
      .gitattributes
      .venv
      *.bak
      **/scratch*
      creds/
      service_account.json
      settings.ini

  - path: /home/ubuntu/.gitconfig
    owner: ubuntu:ubuntu
    content: |
      [core]
        excludesfile = /home/ubuntu/.gitignore
      [pull]
        rebase = true

final_message: "The system is finally up, after $UPTIME seconds"
